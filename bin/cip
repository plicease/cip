#!/bin/bash

set -e

if [ "x$CIP_TAG" == "x" ]; then
  export CIP_TAG=default
fi

function usage {
  cat <<EOF
usage: $0 [subcommand]

subcommands:

  cip travis_yml
    - generate a .travis.yml that uses cip

  cip start
  cip before_install
  cip before-install
    - start background container

  cip diag
    - print perl diagnostics

  cip install
    - install necessary dzil and perl prereqs

  cip script
  cip test
    - test your dist

  cip sudo [command [ ... ] ]
    - exec command in container as root

  cip exec [command [ ... ] ]
    - exec command in container as user

  cip exec-background [command [ ... ] ]
    - exec command in the background

  cip bash [ ... ]
  cip tcsh [ ... ]
  cip perl [ ... ]
  cip nano [ ... ]
    - interactive session with bash, tcsh, perl or nano

  cip stop
    - stop the background container

  cip stop_all
  cip stop-all
  cip clean_all
  cip clean-all
    - stop all background cip containes and remove scn images

  cip scn build
    - build scn images

  cip scn run [ test-name ]
    - run scn tests

  cip scn clean
    - remove all scn images

environment:

  CIP_TAG  the docker tag for plicease/ciperl defaults to 'default'
EOF
  exit 2
}

if [ "x$1" == "x" ]; then
  if [ "x$CIP_COMMAND" == "x" ]; then
    usage
  else
    command=$CIP_COMMAND
    export -n CIP_COMMAND
  fi
else
  command=$1
  shift
fi

export CIP_COMP=$(basename $(pwd))
export CIP_CONT=cip-$CIP_COMP-$CIP_TAG

function cip_local_lib {
  container_path=$(docker exec $CIP_CONT printenv PATH)
  # PERL_MB_OPT "--install_base /home/cip/perl5"
  export CIP_LOCAL_LIB="-e PATH=/home/cip/perl5/bin:$container_path -e PERL5LIB=/home/cip/perl5/lib/perl5 -e PERL_MM_OPT=INSTALL_BASE=/home/cip/perl5"
}

function dist_dir_name {
  export CIP_DIST_DIR=$(grep ^name dist.ini | head -1 | cut -d= -f2 | sed 's/^[ ]*//' | sed 's/[ ]*$//')-$(grep ^version dist.ini | head -1 | cut -d= -f2 | sed 's/^[ ]*//' | sed 's/[ ]*$//')
}

function travis_yml {
  cat > .travis.yml <<'EOF'
language: minimal
dist: xenial
services:
  - docker

before_install:
  - curl https://raw.githubusercontent.com/plicease/cip/master/bin/travis-bootstrap | bash
  - cip before-install

install:
  - cip diag
  - cip install

script:
  - cip script

jobs:
  include:
    - env: CIP_TAG=5.31
    - env: CIP_TAG=5.30
    - env: CIP_TAG=5.28
    - env: CIP_TAG=5.26
    - env: CIP_TAG=5.24
    - env: CIP_TAG=5.22
    - env: CIP_TAG=5.20
    - env: CIP_TAG=5.18
    - env: CIP_TAG=5.16
    - env: CIP_TAG=5.14
    - env: CIP_TAG=5.12
    - env: CIP_TAG=5.10
    - env: CIP_TAG=5.8

cache:
  directories:
    - "$HOME/.cip"
EOF
}

mkdir -p ~/.cip/install-cache/$CIP_TAG
mkdir -p ~/.cip/dzil-cache/$CIP_TAG
if [ "x$TRAVIS" == "xtrue" ]; then
  find ~/.cip/dzil-cache    -print0 | xargs -0 -L 300 sudo chown -R 0:0
  find ~/.cip/install-cache -print0 | xargs -0 -L 300 sudo chown -R 1000:1000
fi

case "$command" in

  travis_yml)
    travis_yml
    ;;

  before_install|before-install|start)
    docker run \
      --name $CIP_CONT \
      -v `pwd`:/work \
      -v ~/.cip:/home/cip/.cip \
      -v ~/.cip/install-cache/"$CIP_TAG":/home/cip/perl5 \
      -v ~/.cip/dzil-cache/"$CIP_TAG":/home/cip/dzil \
      -d \
      plicease/ciperl:$CIP_TAG \
      sleep 86400
    case "$command" in
      before_install|before-install)
        echo "+docker version"
        docker version
        echo "+docker image ls"
        docker image ls
        echo "+docker ps"
        docker ps
      ;;
    esac
    # TODO: this works around the fact that the minor version (the y in 5.x.y)
    # may have changed and we may have a cached local::lib.  It's possible that
    # there may be a breaking change between minor versions in a dev release
    # so it would be better to detect that change and clear the cache.
    cip bash -c 'id'
    cip bash -c 'curl https://cpanmin.us | perl - -n --reinstall App::cpanminus'
    if [ -f maint/cip-before-install ]; then
      ./maint/cip-before-install
    fi
    ;;

  diag)
    cip exec perl -V
    ;;

  install)
    cip_local_lib
    if [ -f maint/cip-install ]; then
      ./maint/cip-install
    elif [ -f dist.ini ]; then
      echo ":::: DZIL DEPS   ::::"
      if [ -f alienfile ]; then
        cip sudo bash -c 'dzil-af missing | dzil-cpanm -n'
      fi
      cip sudo bash -c 'dzil-dzil authordeps --missing | dzil-cpanm -n'
      echo ":::: DZIL BUILD  ::::"
      cip exec dzil-dzil build
      echo ":::: MODULE DEPS ::::"
      dist_dir_name
      cip exec bash -c "cd $CIP_DIST_DIR; cpanm -n --installdeps ."
    elif [ -f Makefile.PL ] || [ -f Build.PL ] || [ -f cpanfile ]; then
      cip exec cpanm -n --installdeps .
    else
      echo "unknown installer"
      exit 2;
    fi
    ;;

  scn)

    if [ -z "$1" ]; then
      scn_command="run"
    else
      scn_command=$1
      shift
    fi

    if [ -d t/cip ]; then

      case "$scn_command" in

        build)
          for dirname in t/cip/*; do
            test=$(basename $dirname)
            if [ -f "t/cip/$test/Dockerfile" ]; then
              echo +docker build -f t/cip/$test/Dockerfile . --build-arg cip_tag=$CIP_TAG -t scn-$test:$CIP_TAG
              docker build -f t/cip/$test/Dockerfile . --build-arg cip_tag=$CIP_TAG -t scn-$test:$CIP_TAG
            fi
          done
          ;;

        run)
          if [ -z "$1" ]; then
            for dirname in t/cip/*; do
              cip scn run-single $(basename $dirname)
            done
          else
            cip scn run-single $1
          fi
          ;;

        run-single)
          test=$1
          if [ -f "t/cip/$test/Dockerfile" ]; then
            echo +docker run -t --rm scn-$test:$CIP_TAG
            docker run -t --rm scn-$test:$CIP_TAG
          else
            echo "no test $test"
            exit 2
          fi
          ;;

        clean)
          docker images "scn-*" --format '{{json .}}' | while read -r line ; do
            id=$(echo $line | jq -r .ID )
            docker image rm $id
          done
          ;;

        *)
          echo "unknown scn subcommand: $scn_command"
          exit 2
          ;;

      esac

    else
      echo "no t/cip directory";
    fi
    ;;

  script|test)
    cip_local_lib
    if [ -f dist.ini ]; then
      dist_dir_name
      if [ -f "$CIP_DIST_DIR/maint/cip-test" ]; then
        cip bash -c "cd $CIP_DIST_DIR; env PERL_USE_UNSAFE_INC=0 $CIP_ENV ./maint/cip-test"
      elif [ -f "$CIP_DIST_DIR/Makefile.PL" ]; then
        cip exec env PERL_USE_UNSAFE_INC=0 $CIP_ENV bash -c "set -ex; cd $CIP_DIST_DIR; perl Makefile.PL; make; make test TEST_VERBOSE=1"
      elif [ -f "$CIP_DIST_DIR/Build.PL" ]; then
        cip exec env PERL_USE_UNSAFE_INC=0 $CIP_ENV bash -c "set -ex; cd $CIP_DIST_DIR; perl Build.PL; ./Build; ./Build test verbose=1"
      else
        echo "unknown installer (dzil)"
        exit 2;
      fi
    elif [ -f maint/cip-test ]; then
      cip bash -c 'env PERL_USE_UNSAFE_INC=0 ./maint/cip-test'
    elif [ -f Makefile.PL ]; then
      cip exec env PERL_USE_UNSAFE_INC=0 $CIP_ENV bash -c "set -ex; perl Makefile.PL; make; make test TEST_VERBOSE=1"
    elif [ -f Build.PL ]; then
      cip exec env PERL_USE_UNSAFE_INC=0 $CIP_ENV bash -c "set -ex; perl Build.PL; ./Build; ./Build test verbose=1"
    elif [ -d t ]; then
      cip exec env PERL_USE_UNSAFE_INC=0 $CIP_ENV bash -c "set -ex; prove -lvm"
    else
      echo "unknown instaler"
      exit 2;
    fi
    ;;

  sudo)
    docker exec $CIP_CONT "$@"
    ;;

  exec)
    cip_local_lib
    docker exec $CIP_LOCAL_LIB -e PERL_MB_OPT="--install_base /home/cip/perl5" -u 1000 $CIP_CONT "$@"
    ;;

  exec-background)
    cip_local_lib
    docker exec -d $CIP_LOCAL_LIB -e PERL_MB_OPT="--install_base /home/cip/perl5" -u 1000 $CIP_CONT "$@"
    ;;

  bash|tcsh|perl|nano)
    cip_local_lib
    if [ "x$CIP_ENV" == "x" ]; then
      docker exec $CIP_LOCAL_LIB -e PERL_MB_OPT="--install_base /home/cip/perl5" -it -u 1000 $CIP_CONT $command "$@"
    else
      docker exec $CIP_LOCAL_LIB -e PERL_MB_OPT="--install_base /home/cip/perl5" -it -u 1000 $CIP_CONT env $CIP_ENV $command "$@"
    fi
    ;;

  stop)
    docker stop /$CIP_CONT
    docker container rm /$CIP_CONT
    ;;

  stop_all|stop-all|clean_all|clean-all)
    cip scn clean
    for name in $( docker ps --format '{{json .Names}}' ) ; do
      name=$( echo $name | jq -r . )
      if echo $name | grep -q ^cip- ; then
        docker stop /$name
        docker container rm /$name
      fi
    done
    ;;

  *)
    echo unknown command: $command
    exit 2
    ;;

esac

